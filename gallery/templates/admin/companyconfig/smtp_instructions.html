{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        :root {
            --primary-colour: #4299e1;
            --primary-hover: #3182ce;
            --secondary-colour: #e2e8f0;
            --secondary-hover: #cbd5e0;
            --success-colour: #48bb78;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-colour: #e2e8f0;
            --background-light: #f7fafc;
            --warning-bg: #fef5e7;
            --warning-border: #ed8936;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition-base: all 0.2s ease;
            --transition-modal: opacity 0.3s ease, transform 0.3s ease;
        }

        .smtp-help-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--background-light);
            border-radius: 0.5rem;
            border: 1px solid var(--border-colour);
            box-shadow: var(--shadow-sm);
        }

        .smtp-help-button {
            background: var(--primary-colour);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition-base);
            font-size: 0.9375rem;
        }

        .smtp-help-button:hover {
            background: var(--primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .smtp-help-button:active {
            transform: translateY(0);
        }

        /* 1.  Remove the blur that causes the wash-out */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55); /* slightly darker so it still looks crisp */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s ease, transform .3s ease;
            /* backdrop-filter removed completely */
        }

        /* 2.  Keep the container clean */
        .modal-container {
            background: #fff;
            border-radius: .75rem;
            width: 90%;
            max-width: 56rem;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .15),
            0 10px 10px -5px rgba(0, 0, 0, .08);
            transform: scale(.95) translateY(1rem);
            transition: transform .3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1) translateY(0);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-colour);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--background-light);
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: var(--transition-base);
            line-height: 1;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--secondary-colour);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            gap: 1rem;
        }

        .step-line {
            position: absolute;
            top: 50%;
            left: 25%;
            right: 25%;
            height: 2px;
            background: var(--secondary-colour);
            transform: translateY(-50%);
            z-index: 0;
        }

        .step-line-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary-colour);
            transition: width 0.3s ease;
        }

        .step {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--secondary-colour);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            z-index: 1;
            transition: var(--transition-base);
            font-size: 1rem;
        }

        .step.active {
            background: var(--primary-colour);
            color: white;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.2);
        }

        .step.completed {
            background: var(--success-colour);
            color: white;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(0.5rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .step-description ol,
        .step-description ul {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .step-description li {
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .step-description a {
            color: var(--primary-colour);
            text-decoration: underline;
            transition: colour 0.2s ease;
        }

        .step-description a:hover {
            color: var(--primary-hover);
        }

        .step-description strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            border: none;
            font-size: 0.9375rem;
        }

        .btn-primary {
            background: var(--primary-colour);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary-colour);
            color: var(--text-secondary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--secondary-hover);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-warning {
            background: var(--warning-bg);
            border-color: var(--warning-border);
            color: #744210;
        }

        .alert-info {
            background: #e6f7ff;
            border-color: var(--primary-colour);
            color: #0c5393;
        }

        .code {
            background: var(--background-light);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border-colour);
            color: #c7254e;
            white-space: nowrap;
        }

        .settings-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .settings-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--background-light);
            border-radius: 0.375rem;
            border: 1px solid var(--border-colour);
        }

        .section-heading {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .modal-container {
                width: 95%;
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }

            .modal-header,
            .modal-body {
                padding: 1rem;
            }

            .action-buttons {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
            }

            .step-indicator {
                gap: 0.5rem;
            }

            .step {
                width: 2rem;
                height: 2rem;
                font-size: 0.875rem;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .step-line {
                left: 20%;
                right: 20%;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
{% endblock %}

{% block after_field_sets %}
    <div class="smtp-help-container">
        <button type="button" class="smtp-help-button" id="smtpHelpButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
            </svg>
            Need help with Gmail SMTP configuration?
        </button>
    </div>

    <div class="modal-overlay" id="smtpModal" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
        <div class="modal-container" role="document">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Gmail SMTP Configuration Guide
                </h2>
                <button type="button" class="modal-close" id="closeModal" aria-label="Close modal">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <div class="step-indicator" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="4">
                    <div class="step-line">
                        <div class="step-line-progress" id="stepProgress"></div>
                    </div>
                    <div class="step active" data-step="1" aria-label="Step 1">1</div>
                    <div class="step" data-step="2" aria-label="Step 2">2</div>
                    <div class="step" data-step="3" aria-label="Step 3">3</div>
                    <div class="step" data-step="4" aria-label="Step 4">4</div>
                </div>

                <!-- Step 1 -->
                <div class="step-content active" data-step="1">
                    <div class="step-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Enable 2-Step Verification
                    </div>
                    <div class="step-description">
                        <p>Google requires 2-Step Verification to be enabled before you can create App Passwords. This
                            adds an extra layer of security to your account.</p>
                        <ol>
                            <li>Go to your <a href="https://myaccount.google.com/" target="_blank"
                                              rel="noopener noreferrer">Google Account</a></li>
                            <li>In the navigation panel, select <strong>Security</strong></li>
                            <li>Under "How you sign in to Google", select <strong>2-Step Verification</strong></li>
                            <li>Follow the on-screen instructions to enable it using your preferred method (mobile
                                phone, authenticator app, etc.)
                            </li>
                        </ol>
                        <div class="alert alert-info">
                            <strong>Note:</strong> If 2-Step Verification is already enabled, you can proceed to the
                            next step.
                        </div>
                    </div>
                    <div class="action-buttons">
                        <div></div>
                        <button type="button" class="btn btn-primary" data-action="next">
                            Next: Create App Password
                        </button>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="step-content" data-step="2">
                    <div class="step-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Generate App Password
                    </div>
                    <div class="step-description">
                        <p>An App Password is a 16-character code that gives your application permission to access your
                            Gmail account. This is more secure than using your regular password.</p>
                        <ol>
                            <li>Visit the <a href="https://myaccount.google.com/apppasswords" target="_blank"
                                             rel="noopener noreferrer">App Passwords</a> page (you may need to sign in
                                again)
                            </li>
                            <li>In the "App name" field, enter a descriptive name like "Django Website" or "My
                                Application"
                            </li>
                            <li>Click <strong>Create</strong></li>
                            <li>Google will generate a 16-character password—copy it immediately</li>
                        </ol>
                        <div class="alert alert-warning">
                            <strong>Important:</strong> This password is displayed only once. Store it securely—you'll
                            need it for the SMTP configuration. If you lose it, you'll need to generate a new one.
                        </div>
                        <div class="alert alert-info">
                            <strong>Tip:</strong> You can create multiple App Passwords for different applications. This
                            allows you to revoke access to specific apps without affecting others.
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" data-action="previous">
                            Back
                        </button>
                        <button type="button" class="btn btn-primary" data-action="next">
                            Next: Configure Settings
                        </button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="step-content" data-step="3">
                    <div class="step-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                        Configure SMTP Settings
                    </div>
                    <div class="step-description">
                        <p>Use these Gmail SMTP settings in the form above. All fields are required for proper email
                            delivery:</p>
                        <ul class="settings-list">
                            <li><strong>Email Host:</strong> <span class="code">smtp.gmail.com</span></li>
                            <li><strong>Email Port:</strong> <span class="code">587</span> (recommended, uses TLS) or
                                <span class="code">465</span> (uses SSL)
                            </li>
                            <li><strong>Use TLS:</strong> <strong>Yes</strong> (if using port 587)</li>
                            <li><strong>Use SSL:</strong> <strong>Yes</strong> (if using port 465)</li>
                            <li><strong>Email Username:</strong> Your complete Gmail address (e.g., <span class="code">yourname@gmail.com</span>)
                            </li>
                            <li><strong>Email Password:</strong> The 16-character App Password you just generated</li>
                            <li><strong>From Address:</strong> Your Gmail address (optional, defaults to username)</li>
                            <li><strong>To Address:</strong> Where contact form emails should be sent (optional,
                                defaults to username)
                            </li>
                        </ul>
                        <div class="alert alert-info">
                            <strong>Recommended:</strong> Port 587 with TLS is the modern standard and offers better
                            compatibility. Port 465 with SSL is an older option but still supported.
                        </div>
                        <div class="alert alert-warning">
                            <strong>Note:</strong> Google deprecated "Less Secure Apps" access. App Passwords are now
                            the only supported method for third-party applications.
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" data-action="previous">
                            Back
                        </button>
                        <button type="button" class="btn btn-primary" data-action="next">
                            Next: Security & Troubleshooting
                        </button>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="step-content" data-step="4">
                    <div class="step-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        Security & Troubleshooting
                    </div>
                    <div class="step-description">
                        <h3 class="section-heading">Security Best Practices</h3>
                        <ul>
                            <li>Never share your App Password with anyone</li>
                            <li>Store your App Password securely (use environment variables in production)</li>
                            <li>Revoke App Passwords immediately if you suspect compromise</li>
                            <li>Create separate App Passwords for each application or device</li>
                            <li>Consider using a dedicated Gmail account for your website to separate personal and
                                business communications
                            </li>
                            <li>Regularly review active App Passwords in your <a
                                    href="https://myaccount.google.com/apppasswords" target="_blank"
                                    rel="noopener noreferrer">Google Account</a></li>
                        </ul>

                        <h3 class="section-heading">Gmail Sending Limits</h3>
                        <ul>
                            <li><strong>Free Gmail accounts:</strong> Up to 500 emails per day</li>
                            <li><strong>Google Workspace accounts:</strong> Up to 2,000 emails per day</li>
                            <li>Exceeding limits may result in temporary sending restrictions</li>
                        </ul>

                        <h3 class="section-heading">Common Issues & Solutions</h3>
                        <ul>
                            <li><strong>Authentication failed:</strong> Double-check your Gmail address and App Password
                                (ensure no spaces)
                            </li>
                            <li><strong>Connection timeout:</strong> Verify that your server/firewall allows outbound
                                connections on port 587 or 465
                            </li>
                            <li><strong>SSL/TLS errors:</strong> Ensure you're using the correct port for your
                                encryption method (587 for TLS, 465 for SSL)
                            </li>
                            <li><strong>Password incorrect:</strong> Generate a new App Password and try again</li>
                            <li><strong>Emails not sending:</strong> Check Django's email backend configuration in <span
                                    class="code">settings.py</span></li>
                        </ul>

                        <div class="alert alert-warning">
                            <strong>Note:</strong> If you change your Google Account password, all App Passwords are
                            automatically revoked for security. You'll need to generate new ones.
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" data-action="previous">
                            Back
                        </button>
                        <button type="button" class="btn btn-primary" data-action="close">
                            Finish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            const STEP_COUNT = 4;
            const ANIMATION_DELAY = 300;

            const elements = {
                modal: document.getElementById('smtpModal'),
                helpButton: document.getElementById('smtpHelpButton'),
                closeButton: document.getElementById('closeModal'),
                stepProgress: document.getElementById('stepProgress'),
                stepIndicators: document.querySelectorAll('.step'),
                stepContents: document.querySelectorAll('.step-content')
            };

            let currentStep = 1;

            const updateStepDisplay = () => {
                elements.stepContents.forEach((content, index) => {
                    const stepNumber = index + 1;
                    content.classList.toggle('active', stepNumber === currentStep);
                });

                elements.stepIndicators.forEach((indicator, index) => {
                    const stepNumber = index + 1;
                    indicator.classList.remove('active', 'completed');

                    if (stepNumber === currentStep) {
                        indicator.classList.add('active');
                    } else if (stepNumber < currentStep) {
                        indicator.classList.add('completed');
                    }
                });

                const progress = ((currentStep - 1) / (STEP_COUNT - 1)) * 100;
                elements.stepProgress.style.width = `${progress}%`;

                const progressBar = document.querySelector('.step-indicator');
                progressBar.setAttribute('aria-valuenow', currentStep);
            };

            const openModal = () => {
                elements.modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                elements.closeButton.focus();
            };

            const closeModal = () => {
                elements.modal.classList.remove('active');
                document.body.style.overflow = '';
                currentStep = 1;
                updateStepDisplay();
                elements.helpButton.focus();
            };

            const navigateStep = (direction) => {
                const nextStep = currentStep + direction;

                if (nextStep >= 1 && nextStep <= STEP_COUNT) {
                    currentStep = nextStep;
                    updateStepDisplay();
                }
            };

            const handleActionClick = (e) => {
                const button = e.target.closest('[data-action]');
                if (!button) return;

                const action = button.dataset.action;

                switch (action) {
                    case 'next':
                        navigateStep(1);
                        break;
                    case 'previous':
                        navigateStep(-1);
                        break;
                    case 'close':
                        closeModal();
                        break;
                }
            };

            const handleKeydown = (e) => {
                if (!elements.modal.classList.contains('active')) return;

                switch (e.key) {
                    case 'Escape':
                        closeModal();
                        break;
                    case 'ArrowRight':
                        if (currentStep < STEP_COUNT) {
                            navigateStep(1);
                        }
                        break;
                    case 'ArrowLeft':
                        if (currentStep > 1) {
                            navigateStep(-1);
                        }
                        break;
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === elements.modal) {
                    closeModal();
                }
            };

            elements.helpButton.addEventListener('click', openModal);
            elements.closeButton.addEventListener('click', closeModal);
            elements.modal.addEventListener('click', handleOverlayClick);
            document.addEventListener('keydown', handleKeydown);

            elements.modal.addEventListener('click', handleActionClick);

            updateStepDisplay();
        })();
    </script>
{% endblock %}